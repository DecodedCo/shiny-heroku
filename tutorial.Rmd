---
title: "Shiny on Heroku"
author: "Andrew Watson"
runtime: shiny
date: "May 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(error = FALSE)
```

## Intro

This tutorial[^1] teaches you how to

  - Host R Shiny applications on the [Heroku](https://heroku.com) platform
  - Apply security to those applications via forced https, OAuth, and nginx
  - Use Heroku Postgres with the apps
  
## Requirements

You'll need to install a lot of software if you haven't already.[^2] Let's assume that if you've gotten this far you've installed R + RStudio, but perhaps you haven't installed some of the Heroku specific requirements.

  - [Git](https://git-scm.com/downloads)
  - [Heroku command line tools](https://devcenter.heroku.com/articles/heroku-cli). You'll also need a [Heroku account](https://heroku.com).[^3]
  - [latest PostgresQL](https://www.enterprisedb.com/downloads/postgres-postgresql-downloads). **Huge note** when you install this, please make sure you remember your superuser password. For the sake of this tutorial, we will assume you set the password as **admin**.

## Your first Heroku app

Let's get started by creating a simple unsecured Heroku application. The application files are located in the `1. simple unsecured app`() directory of this repository

### Create a new repo, or fork this one.

Either fork this repository by clicking the [fork button]() on the Github page, or create your own on [Github](https://github.com). If you have Git installed you can clone directly in RStudio by going to

    File > New Project... > Version Control > Git
    
Make sure you are running RStudio with adminsistrator rights if you are on Windows, and make sure you've restarted your computer since installing Git.

### Create a new Shiny application

Once you have your repository built create your Shiny app by going to

    File > New File > Shiny Web App...
    
Name the file as you will (in this example we name it *my-app* and select the `Single File (app.R)` option. 

By default this will create a new folder in your directory with the name of your app. **Move the app.R file out of the new directory and into the main directory of your repository.** Delete the now empty folder that the `app.R` file was in.

You can quickly run your first simple app if you wish by opening the `app.R` file. In RStudio a button should appear in the upper right hand corner with a green triangle that says `Run App`. Alternatively, you can just run the file. You should see the default Shiny app open up with the Geyser's visualization, similar to the below.

***

#### Old Faithful Geyser Data
```{r echo=FALSE}

sliderInput("bins",
           "Number of bins:",
           min = 1,
           max = 50,
           value = 30)

```


```{r echo=FALSE}
renderPlot({
    # generate bins based on input$bins from ui.R
    x    <- faithful[, 2] 
    bins <- seq(min(x), max(x), length.out = input$bins + 1)
    
    # draw the histogram with the specified number of bins
    hist(x, breaks = bins, col = 'darkgray', border = 'white')
 })

```


### Add a `run.R` file

In order to have the application work with Heroku, you will need a `run.R` file. The Heroku app *runs* the `run.R` file once it starts up (woah!). This file does any setup that needs to occur before the app itself is launched. In this first unsecured app with a single file `app.R` the `run.R` file will simply set the port and run the application. To create the `run.R` file go to

    File > New File > R Script
    
Copy + paste in the code below into the file.

```{r eval=FALSE}
# simple run.R
library(shiny)

# Gets the port # from Heroku
port <- Sys.getenv('PORT')

# Runs the app in the working directory. By default this will search for an `app.R` file or 
# a ui.R + server.R file combination
# The host of 0.0.0.0 indicates the app runs at the web server's ip address
shiny::runApp(
  appDir = getwd(),
  host = '0.0.0.0',
  port = as.numeric(port)
)
```

Save that shit!

### Have all your files?

Woo! you now have all you need for your first app.

Your file directory should only have the following files in it,

     app.R
     run.R
     some .Rproj file
     .gitignore

If you forked this repository you have some other junk, but those are the essentials. **If you do not see all those files in your repository, go back and carefully re-read these instructions.**

### Commit & Push

Remember, when using R with Github to *commit* and *push*[^4] your work as frequently as possible to avoid losing work, propogating errors, and generally being bad at your job. 

#### Using the nice interface

In RStudio you can do this by selecting

    Tools > Version Control > Commit...
    
Or if you prefer hot keys

    Ctrl + Alt + M

Select the checkboxes next to the files and changes you have made to *Stage* changes for the commit. Write a message in the Commit box then click the `Commit` button. This should run the Git command to commit your changes.

Once your changes are *committed* select the *Push* button to upload those changes to Github. 

#### Using the Terminal (preferred way)

You can also *commit* and *push* by running the commands directly into the `Terminal` window in RStudio.

To open the Terminal either click the Terminal window in the bottom pane of your screen or go to

    Tools > Terminal > Move Focus to Terminal
    
Again, if you prefer hotkeys the command is

    Alt + Shift + T

In the Terminal run the following commands,

To commit (backup) your changes

    $ git add *
    
    $ git commit -m "added app.R and run.R files"
    
Each time you commit, you need to run those two commands. The `-m` option stands for *message*. You can change this based on what you actually changed.

To push (upload) your changes run this command. Remember, `origin` is Git speak for Github.

    $ git push origin
    
When using Heroku, we will be focusing on using the Terminal Git commands.

### Heroku command line tools

Time to upload this shit to Heroku and startup the app. To interact with Heroku we will use the Heroku command line tools, again by using the RStudio Terminal window.

Navigate to the Terminal
    
    Alt + Shift + T
    
Type in `heroku` and hit enter. You should see a large list of base commands pop up. You should always go back to this list when wondering *how the hell do I do this in the Heroku command line?* Remember also, you can find the options, explanation, and examples for any command in heroku by running

    $ heroku help command-name

For example, to figure out how to login you can run

    $ heroku help login
    
#### heroku login

If you are using a simple free Heroku account you can login by using

    $ heroku login
    
and passing in your credentials.


If you have an enterprise heroku account, with single sign on (sso) enabled **hint hint Salesforce employees this is you!** run the following command,

    $ heroku login --sso
  
When it prompts you, add the name of your organization (for Salesforce employees this is `sfdc-aloha`) and then pass in the appropriate access token from the web browser window that opens. Note that when using the Terminal common copy paste commands `Ctrl + V` and `Ctrl + C` are disabled. You need to right click `Paste` to paste items into the Terminal.

#### heroku apps:create

Now that you've hopefully managed to login let's create your first app using the `heroku apps:create` command. Remember, you can see the options of this command by running

    $ heroku help apps:create 
    
This will create a default app in your personal app space simply run the following,

    $ heroku apps:create name-of-your-app

If you are running Heroku Enterprise and have a specific organization and or Private Space (**looking at you F&S**), you can set further parameters by doing
    
    $ heroku apps:create name-of-your-secure-app -t sfdc-gbo-fns --space fns-confidential
    
Creating an app in a Private Space is expensive but will make it incredibly secure. Only do this if hosting app with company confidential and or sensitive data.

#### heroku buildpacks

Now that we've created the app we need to tell Heroku to install R on it. You can instruct Heroku to install certain programs on an app by using **buildpacks.** Heroku has some standard buildpacks, but most of them are created by community members and hosted on Github.

For our apps we are going to start by using the [Heroku buildpack R](https://github.com/virtualstaticvoid/heroku-buildpack-r/tree/heroku-16). Note we are using the heroku-16 version.

<h5 style='color: red'>**STOP**</h5>

Before going on with the tutorial please **EXTENSIVELY** review the documentation on the [buildpack's website](https://github.com/virtualstaticvoid/heroku-buildpack-r/tree/heroku-16). Most of the tutorial will be leveraging information in that documentation, and will assume you have read it.

Okay, now that you've read that add the buildpack to the app,

    $ heroku buildpacks:add http://github.com/virtualstaticvoid/heroku-buildpack-r.git#heroku-16
    
### Push to heroku!

Once the buildpack has been added you are good to go. You can push your brand new app directly to heroku by using the following command in the Terminal,

    $ git push heroku master
    

[^1]: I will leave the debate as to whether or not Heroku is an effective platform for hosting Shiny Apps to the cynics. For beginners, its super easy, and allows for database backend / more customizability than options such as ShinyApps.io. You can also layer on more advanced security features, add-ons, etc. 

[^2]: If you are a Salesforce F&S user of this, you can refer to the [Quip doc](https://salesforce.quip.com/TkOlAkNxVWqJ) on how to install the core software required for this.

[^3]: Salesforce F&S users, hello again, you'll need to create a Heroku account by going to this [link here](https://sso.heroku.com/saml/sfdc-aloha/init). Please also reference the Concierge article on [Heroku for SFDC Employees](https://concierge.it.salesforce.com/articles/en_US/Supportforce_Article/Heroku-for-SFDC-Employees) for common questions.

[^4]: In Git speak to *commit* something is to save and back it up. To *push* is to upload that latest backup (*commit*) to the internet (i.e. Github), Github is referred to as *origin*. You can upload to different places on the internet by adding other *remotes*. A *remote* is simply a location on the internet you are uploading your code to. 